<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Impostor Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial; text-align:center; font-size:22px; padding:15px; }
h1{font-size:34px}
button,input{font-size:22px;padding:12px;margin:6px;width:90%;max-width:360px}
.hidden{display:none}
.player-button{display:block;margin:8px auto;font-size:24px}
.player-button:disabled{background:#ccc}
.scoreboard{margin-bottom:10px;font-size:20px}
.timer{font-size:48px;margin:20px}
.category{font-weight:bold}
.target{color:darkred}
</style>
</head>
<body>

<h1>Impostor Game</h1>

<div id="setup">
  <h2>Add Players</h2>
  <input id="nameInput" placeholder="Name">
  <button onclick="addPlayer()">Add Player</button>
  <ul id="playerList"></ul>
  <button onclick="startGame()">Start Game</button>
</div>

<div id="playerSelect" class="hidden">
  <div id="scoreboard" class="scoreboard"></div>
  <h2>Select Your Name</h2>
  <div id="playerButtons"></div>
  <button onclick="showStarter()">Continue</button>
</div>

<div id="revealScreen" class="hidden">
  <h2 id="revealTitle"></h2>
  <div id="categoryText" class="category"></div>
  <div id="revealText"></div>
  <div id="targetText" class="target"></div>
  <button onclick="back()">Done</button>
  <button onclick="addPlayerPrompt()">Add Player</button>
</div>

<div id="starterScreen" class="hidden">
  <h2>Starting Player</h2>
  <div id="starterName" style="font-size:40px"></div>
  <button onclick="startDiscussion()">Start Discussion</button>
</div>

<div id="timerScreen" class="hidden">
  <h2 id="timerTitle"></h2>
  <div id="timerDisplay" class="timer"></div>
  <button onclick="skipTimer()">Skip</button>
</div>

<div id="roundEnd" class="hidden">
  <h2>Round Result</h2>
  <button onclick="endRound('lost')">Impostor Lost</button>
  <button onclick="endRound('won')">Impostor Won</button>
  <button onclick="endRound('target')">Target Out, No Word (+15)</button>
  <button onclick="endRound('targetWord')">Target + Word (+45)</button>
  <button onclick="endRound('skip')">Skip Round</button>
</div>

<script>
let players=[],scores={},impostorHistory={};
let impostors=[],target="",category="",word="",hint="";
let viewed=new Set(),data=[],usedWords={},timerInt,phase="";

fetch("Impostor.json").then(r=>r.json()).then(j=>{
  data=j;
  data.forEach(o=>usedWords[Object.keys(o)[0]]=new Set());
});

function addPlayer(){
  const input=document.getElementById("nameInput");
  let n=input.value.trim();
  if(!n||players.includes(n))return;
  players.push(n);scores[n]=0;impostorHistory[n]=[];
  let li=document.createElement("li");li.textContent=n;
  document.getElementById("playerList").appendChild(li);
  input.value="";
}

function addPlayerPrompt(){
  let n=prompt("Enter player name:");
  if(!n||players.includes(n))return;
  players.push(n);scores[n]=0;impostorHistory[n]=[];
  updateScores();makeButtons();
}

function startGame(){
  if(players.length<3){alert("Need 3 players");return;}
  setup.classList.add("hidden");
  newRound();
}

function newRound(){
  viewed.clear();
  impostors=[];
  let impostorCount=players.length>=7?2:1;

  // ----- TIERED FAIRNESS SELECTION -----
  let tier0=[],tier1=[],tier2=[];
  players.forEach(p=>{
    let last4=impostorHistory[p].slice(-4);
    let count=last4.filter(x=>x).length;
    if(count===0) tier0.push(p);
    else if(count===1) tier1.push(p);
    else tier2.push(p);
  });

  function pick(arr){
    if(arr.length===0)return null;
    let i=Math.floor(Math.random()*arr.length);
    return arr.splice(i,1)[0];
  }

  [tier0,tier1,tier2].forEach(pool=>{
    while(impostors.length<impostorCount && pool.length>0){
      impostors.push(pick(pool));
    }
  });

  while(impostors.length<impostorCount){
    let r=players[Math.floor(Math.random()*players.length)];
    if(!impostors.includes(r))impostors.push(r);
  }

  players.forEach(p=>{
    impostorHistory[p].push(impostors.includes(p));
    if(impostorHistory[p].length>4)impostorHistory[p].shift();
  });

  let innocents=players.filter(p=>!impostors.includes(p));
  target=innocents[Math.floor(Math.random()*innocents.length)];

  pickWord();
  updateScores();
  makeButtons();
  playerSelect.classList.remove("hidden");
}

function pickWord(){
  let obj,avail;
  do{
    obj=data[Math.floor(Math.random()*data.length)];
    category=Object.keys(obj)[0];
    avail=Object.keys(obj[category]).filter(w=>!usedWords[category].has(w));
    if(avail.length===0)usedWords[category].clear();
  }while(avail.length===0);
  word=avail[Math.floor(Math.random()*avail.length)];
  hint=obj[category][word];
  usedWords[category].add(word);
}

function updateScores(){
  scoreboard.innerHTML="Scores:<br>"+players.map(p=>`${p}: ${scores[p]}`).join(" | ");
}

function makeButtons(){
  playerButtons.innerHTML="";
  players.forEach(p=>{
    let b=document.createElement("button");
    b.textContent=p;b.className="player-button";
    b.onclick=()=>reveal(p,b);
    playerButtons.appendChild(b);
  });
}

function reveal(p,b){
  if(viewed.has(p))return;
  viewed.add(p);b.disabled=true;
  playerSelect.classList.add("hidden");
  revealScreen.classList.remove("hidden");
  categoryText.textContent="Category: "+category;
  targetText.textContent="";

  if(impostors.includes(p)){
    revealTitle.textContent="You are IMPOSTOR";
    revealText.textContent="Hint: "+hint;
    targetText.textContent="Target: "+target;
  }else{
    revealTitle.textContent="You know the word";
    revealText.textContent="Word: "+word;
  }
}

function back(){revealScreen.classList.add("hidden");playerSelect.classList.remove("hidden");}

function showStarter(){
  let s=players[Math.floor(Math.random()*players.length)];
  playerSelect.classList.add("hidden");
  starterScreen.classList.remove("hidden");
  starterName.textContent=s;
}

function startDiscussion(){starterScreen.classList.add("hidden");startTimer(300,"Discussion & Vote");}

function startTimer(sec,title){
  phase=title;timerScreen.classList.remove("hidden");timerTitle.textContent=title;
  let t=sec;updateTimer(t);
  timerInt=setInterval(()=>{t--;updateTimer(t);if(t<=0){clearInterval(timerInt);timerEnd();}},1000);
}

function updateTimer(t){timerDisplay.textContent=Math.floor(t/60)+":"+String(t%60).padStart(2,"0");}
function skipTimer(){clearInterval(timerInt);timerEnd();}

function timerEnd(){
  if(phase==="Discussion & Vote"){startTimer(120,"Impostor Guess");}
  else{timerScreen.classList.add("hidden");roundEnd.classList.remove("hidden");}
}

function endRound(r){
  if(r==="lost")players.forEach(p=>{if(!impostors.includes(p))scores[p]+=5;});
  if(r==="won")impostors.forEach(i=>scores[i]+=15);
  if(r==="target")impostors.forEach(i=>scores[i]+=15);
  if(r==="targetWord")impostors.forEach(i=>scores[i]+=45);
  roundEnd.classList.add("hidden");
  newRound();
}
</script>
</body>
</html>
